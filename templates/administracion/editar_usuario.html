{% extends 'base.html' %}

{% block title %}Editar Usuario{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm border-0 rounded">

        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center" style="background-color:#D71920 !important;">
          <h5 class="mb-0 fw-bold"><i class="bi bi-pencil-square me-2"></i>Editar Usuario</h5>
          <span class="badge bg-light text-danger border border-danger">{{ usuario.email }}</span>
        </div>

        <div class="card-body p-4">

          {% if form.errors %}
            <div class="alert alert-danger d-flex align-items-center">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <div>
                <strong>Hay errores en el formulario:</strong>
                {{ form.non_field_errors }}
              </div>
            </div>
          {% endif %}

          <form method="post">
            {% csrf_token %}

            <!-- SECCIÓN 1: DATOS PERSONALES -->
            <h6 class="text-danger border-bottom pb-2 mb-3" style="color:#D71920 !important;">Información Personal</h6>
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label fw-bold small text-secondary">Nombres</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="text-danger small">{{ form.first_name.errors.0 }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold small text-secondary">Apellidos</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="text-danger small">{{ form.last_name.errors.0 }}</div>{% endif %}
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label fw-bold small text-secondary">Email</label>
                {{ form.email }}
                {% if form.email.errors %}<div class="text-danger small">{{ form.email.errors.0 }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold small text-secondary">RUT</label>
                {{ form.rut }}
                {% if form.rut.errors %}<div class="text-danger small">{{ form.rut.errors.0 }}</div>{% endif %}
              </div>
            </div>

            <!-- SECCIÓN 2: ACCESO -->
            <h6 class="text-danger border-bottom pb-2 mb-3 mt-4" style="color:#D71920 !important;">Configuración de Acceso</h6>

            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label fw-bold small text-secondary">Rol de Sistema</label>
                {{ form.rol }}
                <div class="form-text small">Define si tiene acceso al panel de administración.</div>
              </div>

              <!-- Cargo solo tiene sentido para SOLICITANTE (puedes ocultarlo en ADMIN) -->
              <div class="col-md-6" id="div-tipo">
                <label class="form-label fw-bold small text-secondary">Cargo</label>
                {{ form.tipo_solicitante }}
                {% if form.tipo_solicitante.errors %}<div class="text-danger small">{{ form.tipo_solicitante.errors.0 }}</div>{% endif %}
              </div>
            </div>

            <!-- SECCIÓN ACADÉMICA -->
            <div id="seccion-academica" class="p-3 bg-light rounded border mb-3">
              <h6 class="fw-bold mb-3" style="color:#D71920;">
                <i class="bi bi-diagram-3 me-1"></i>Asignación Académica
              </h6>

              <div class="row g-3">
                <!-- Área -->
                <div class="col-md-6">
                  <label class="form-label fw-bold text-danger" style="color:#D71920 !important;">Área / Facultad</label>
                  {{ form.area }}
                  {% if form.area.errors %}<div class="text-danger small">{{ form.area.errors.0 }}</div>{% endif %}
                  <div class="form-text small">
                    <i class="bi bi-info-circle"></i> Si eliges Carrera, el Área se ajusta automáticamente.
                  </div>
                </div>

                <!-- Carrera (MANUAL con data-area) -->
                <div class="col-md-6" id="div-carrera">
                  <label class="form-label fw-bold text-danger" style="color:#D71920 !important;">Carrera</label>

                  <select name="carrera" id="id_carrera" class="form-select">
                    <option value="">-- Sin Carrera --</option>
                    {% for c in carreras %}
                      <option value="{{ c.id }}" data-area="{{ c.area_id }}"
                        {% if usuario.carrera_id == c.id %}selected{% endif %}>
                        {{ c.nombre }}
                      </option>
                    {% endfor %}
                  </select>

                  <div class="form-text small">
                    <i class="bi bi-mortarboard"></i> Disponible para ADMIN y SOLICITANTE.
                  </div>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2 mt-4">
              <button type="submit" class="btn btn-danger btn-lg" style="background-color:#D71920 !important; border-color:#D71920;">
                <i class="bi bi-save me-2"></i>Guardar Cambios
              </button>
              <a href="{% url 'gestion_usuarios' %}" class="btn btn-outline-secondary">Cancelar</a>
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const rolSelect = document.getElementById('id_rol');
  const divTipo = document.getElementById('div-tipo');

  const areaSelect = document.getElementById('id_area');
  const carreraSelect = document.getElementById('id_carrera');

  function filterCarrerasByArea() {
    if (!areaSelect || !carreraSelect) return;

    const areaId = areaSelect.value;      // puede ser "" (sin área)
    const current = carreraSelect.value;

    Array.from(carreraSelect.options).forEach(opt => {
      if (!opt.value) { opt.hidden = false; return; } // option vacío

      // ✅ Si no hay área seleccionada => NO filtrar, mostrar todas
      if (!areaId) {
        opt.hidden = false;
        return;
      }

      opt.hidden = (opt.dataset.area !== areaId);
    });

    // si la seleccionada queda oculta -> reset
    const selectedOpt = carreraSelect.options[carreraSelect.selectedIndex];
    if (selectedOpt && selectedOpt.hidden) {
      carreraSelect.value = "";
    } else {
      carreraSelect.value = current;
    }
  }

  function syncAreaFromCarrera() {
    if (!areaSelect || !carreraSelect) return;

    const opt = carreraSelect.options[carreraSelect.selectedIndex];
    if (!opt || !opt.value) return;

    const areaFromCarrera = opt.dataset.area;
    if (areaFromCarrera && areaSelect.value !== areaFromCarrera) {
      areaSelect.value = areaFromCarrera;
      filterCarrerasByArea(); // re-filtra para dejar coherente
    }
  }

  function updateUI() {
    if (!rolSelect) return;
    const isAdmin = (rolSelect.value === 'ADMIN');

    // ✅ ADMIN también puede tener área/carrera, así que NO ocultamos carrera.
    // Solo ocultamos "Cargo" porque es más de solicitante (si quieres que admin también tenga cargo, dime y lo dejamos siempre visible)
    if (divTipo) divTipo.style.display = isAdmin ? 'none' : 'block';

    // ✅ Al cargar, filtrar respetando regla "si no hay área: mostrar todas"
    filterCarrerasByArea();

    // ✅ Si ya hay carrera seleccionada, asegurar que el área coincida
    syncAreaFromCarrera();
  }

  if (rolSelect) rolSelect.addEventListener('change', updateUI);
  if (areaSelect) areaSelect.addEventListener('change', filterCarrerasByArea);
  if (carreraSelect) carreraSelect.addEventListener('change', syncAreaFromCarrera);

  updateUI();
});
</script>
{% endblock %}
