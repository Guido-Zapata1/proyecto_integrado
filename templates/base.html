<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Sistema de Reservas INACAP{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{--inacap-red:#D71920;--inacap-gray:#333}
    body{background:#f8f9fa}
    .navbar{background:var(--inacap-red)}
    .navbar-brand{color:#fff;font-weight:700}
    .sidebar{min-height:100vh;background:#fff;border-right:1px solid #dee2e6}
    .sidebar .nav-link{color:#333!important}
    .sidebar .nav-link:hover{background:#f1f1f1;color:var(--inacap-red)!important}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg shadow-sm">
    <div class="container-fluid">
      <!-- Enlace al Home (Ruta Global) -->
      <a class="navbar-brand" href="{% url 'home' %}"><i class="bi bi-calendar-check"></i> INACAP Reservas</a>
      <div class="d-flex">
        {% if user.is_authenticated %}
          <!-- CORRECCIÓN AQUÍ: Usamos user.email o user.first_name porque user.username es None -->
          <span class="text-white me-3">Hola, {{ user.first_name|default:user.email }}</span>
          
          <!-- Formulario seguro para Logout -->
          <form action="{% url 'logout' %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-light text-danger border-0">Salir</button>
          </form>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-sm btn-light text-danger">Ingresar</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      {% if user.is_authenticated %}
      <nav class="col-md-3 col-lg-2 sidebar py-3 d-md-block collapse" id="sidebarMenu">
        <ul class="nav flex-column">
          
          <!-- ==================== MENU GENERAL ==================== -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'home' %}">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>
          
          <!-- Solo mostramos opciones de crear/listar si NO es Mantenimiento (LEGACY) -->
          {% if user.rol != 'MANTENIMIENTO' %}
          <li class="nav-item">
            <!-- Ruta con namespace 'reservas' porque está en reservas/urls.py -->
            <a class="nav-link" href="{% url 'reservas:crear_reserva' %}">
              <i class="bi bi-plus-circle"></i> Nueva Reserva
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'reservas:listar_reservas' %}">
              <i class="bi bi-clock-history"></i> Mis Reservas
            </a>
          </li>
          {% endif %}

          <!-- ==================== MENU ADMINISTRACIÓN ==================== -->
          {% if user.rol == 'ADMIN' %}
            <hr>
            <p class="px-3 text-muted small fw-bold">ADMINISTRACIÓN</p>
            
            <!-- Rutas Globales (definidas en core/urls.py) -->
            <li class="nav-item">
              <a class="nav-link" href="{% url 'gestion_reservas' %}">
                <i class="bi bi-list-check"></i> Gestión Solicitudes
              </a>
            </li>
            
            <!-- Rutas Globales de Inventario (definidas en inventario/urls.py SIN namespace) -->
            <li class="nav-item">
              <a class="nav-link" href="{% url 'gestion_espacios' %}">
                <i class="bi bi-building"></i> Espacios
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'gestion_recursos' %}">
                <i class="bi bi-box-seam"></i> Inventario
              </a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="{% url 'gestion_usuarios' %}">
                <i class="bi bi-people"></i> Usuarios
              </a>
            </li>
          {% endif %}
          
          <!-- ==================== MI CUENTA (NUEVO) ==================== -->
          <hr>
          <p class="px-3 text-muted small fw-bold">MI CUENTA</p>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'password_change' %}">
              <i class="bi bi-shield-lock"></i> Cambiar Contraseña
            </a>
          </li>
          
        </ul>
      </nav>
      {% endif %}

      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  {% block extra_js %}{% endblock %}
</body>
</html>

