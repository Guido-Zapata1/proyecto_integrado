<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Sistema de Reservas INACAP{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root{--inacap-red:#D71920;--inacap-gray:#333}
    body{background:#f8f9fa}
    .navbar{background:var(--inacap-red)}
    .navbar-brand{color:#fff;font-weight:700}
    .sidebar{min-height:100vh;background:#fff;border-right:1px solid #dee2e6}
    .sidebar .nav-link{color:#333!important}
    .sidebar .nav-link:hover{background:#f1f1f1;color:var(--inacap-red)!important}
    .card{border:0;border-radius:14px}
    .btn-inacap{background:var(--inacap-red);color:#fff;border:0}
    .btn-inacap:hover{opacity:.9;color:#fff}
    .badge-inacap{background:var(--inacap-red)}

    /* ‚úÖ Notificaciones (badge campanita) */
    .notif-badge{
      min-width: 18px;
      font-size: .70rem;
      padding: .25em .45em;
    }
  </style>
  {% block extra_head %}{% endblock %}
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="{% url 'home' %}">
        <i class="bi bi-calendar2-check"></i> INACAP Reservas
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="d-flex align-items-center">
        {% if user.is_authenticated %}

          <!-- üîî Notificaciones -->
          <a class="btn btn-outline-light btn-sm position-relative me-2"
             href="{% url 'notificaciones:lista' %}"
             title="Notificaciones">
            <i class="bi bi-bell"></i>
            <span id="notifBadge"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark notif-badge"
                  style="display:none;">
              0
            </span>
          </a>

          <span class="text-white me-3 small">
            <i class="bi bi-person-circle"></i>
            {{ user.first_name }} {{ user.last_name }}
          </span>

          <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button class="btn btn-light btn-sm">
              <i class="bi bi-box-arrow-right"></i> Salir
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      {% if user.is_authenticated %}
      <nav class="col-md-3 col-lg-2 sidebar py-3 d-md-block collapse" id="sidebarMenu">
        <ul class="nav flex-column">

          <!-- ==================== MENU GENERAL ==================== -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'home' %}">
              <i class="bi bi-speedometer2"></i> Dashboard
            </a>
          </li>

          <!-- Mostrar para SOLICITANTE y ADMIN -->
          {% if user.rol == 'SOLICITANTE' or user.rol == 'ADMIN' %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'reservas:crear_reserva' %}">
              <i class="bi bi-plus-circle"></i> Nueva Reserva
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'reservas:listar_reservas' %}">
              <i class="bi bi-clock-history"></i> Mis Reservas
            </a>
          </li>

          <!-- ‚úÖ REPORTES -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'reportes:home' %}">
              <i class="bi bi-file-earmark-arrow-down"></i> Reportes
            </a>
          </li>

          <!-- ‚úÖ NOTIFICACIONES tambi√©n en sidebar -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'notificaciones:lista' %}">
              <i class="bi bi-bell"></i> Notificaciones
              <span id="notifBadgeSide"
                    class="badge rounded-pill bg-dark ms-2 notif-badge"
                    style="display:none;">0</span>
            </a>
          </li>
          {% endif %}

          <!-- ==================== MENU ADMINISTRACI√ìN ==================== -->
          {% if user.rol == 'ADMIN' %}
            <hr>
            <p class="px-3 text-muted small fw-bold">ADMINISTRACI√ìN</p>

            <li class="nav-item">
              <a class="nav-link" href="{% url 'gestion_reservas' %}">
                <i class="bi bi-list-check"></i> Gesti√≥n Solicitudes
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="{% url 'inventario:gestion_espacios' %}">
                <i class="bi bi-building"></i> Espacios
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="{% url 'inventario:gestion_recursos' %}">
                <i class="bi bi-box-seam"></i> Inventario
              </a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="{% url 'gestion_usuarios' %}">
                <i class="bi bi-people"></i> Usuarios
              </a>
            </li>

            <li class="nav-item mt-2">
              <span class="nav-link disabled text-uppercase fw-bold text-muted small" style="padding-left: 1rem;">
                Configuraci√≥n
              </span>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'gestion_areas' %}">
                <i class="bi bi-building-gear"></i> √Åreas
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'gestion_carreras' %}">
                <i class="bi bi-mortarboard"></i> Carreras
              </a>
            </li>
          {% endif %}

          <!-- ==================== MI CUENTA ==================== -->
          <hr>
          <p class="px-3 text-muted small fw-bold">MI CUENTA</p>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'password_change' %}">
              <i class="bi bi-shield-lock"></i> Cambiar Contrase√±a
            </a>
          </li>

        </ul>
      </nav>
      {% endif %}

      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        {% block content %}{% endblock %}
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ‚úÖ Script Notificaciones: badge + polling -->
  {% if user.is_authenticated %}
  <script>
    async function updateNotifBadge(){
      try{
        const r = await fetch("{% url 'notificaciones:unread_count' %}", { credentials: "same-origin" });
        if(!r.ok) return;

        const data = await r.json();
        const n = Number(data.unread || 0);

        const topBadge = document.getElementById("notifBadge");
        const sideBadge = document.getElementById("notifBadgeSide");

        function applyBadge(badge){
          if(!badge) return;
          if(n > 0){
            badge.style.display = "inline-block";
            badge.textContent = (n > 99) ? "99+" : String(n);
          }else{
            badge.style.display = "none";
            badge.textContent = "0";
          }
        }

        applyBadge(topBadge);
        applyBadge(sideBadge);

      }catch(e){}
    }

    updateNotifBadge();
    setInterval(updateNotifBadge, 30000);
  </script>
  {% endif %}

  {% block extra_js %}{% endblock %}
</body>
</html>
